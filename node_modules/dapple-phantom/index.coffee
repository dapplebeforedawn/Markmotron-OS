fs           = require 'fs'
uuid         = require 'uuid'
remoteCoffee = require 'remote-coffee'

module.exports = (phantomCoffeeUrl, env, callback)->
  remoteCoffee phantomCoffeeUrl, (phantomScript)->
    fifoName = "tmp/#{uuid.v4().replace(/-/g, '')}"
    phantom = require('child_process').spawn 'phantomjs', [fifoName, '--load-images=no'], {env: env}
 
    fromPhantom = ''
    phantom.stdout.on 'data', (data)->
      fromPhantom += data.toString()
 
    phantom.once 'close', (code)->
      callback null, fromPhantom
      
    phantom.once 'error', (error)->
      console.log 'Error creating PhantomJS process: ', error
      callback error, null
 
    stream = fs.createWriteStream fifoName
    stream.once 'open', (fd)->
      stream.write phantomScript
      stream.end()
