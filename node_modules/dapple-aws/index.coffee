fs  = require 'fs'
AWS = require 'aws-sdk'
AWS.config.update
  accessKeyId:      process.env['AWS_KEY']
  secretAccessKey:  process.env['AWS_SECRET']
  region:           'us-east-1'

class DappleAws
  constructor: (@bucketName)->
    
  awsUrl: (filename)->
    "https://s3.amazonaws.com/#{@bucketName}/#{filename}"
    
  filePathToName: (filePath)->
    filePath.match(/[^\/]*$/)[0]
    
  upload: (filePath, callback)->
    self = @
    fs.readFile filePath, (err, data)->
      if err
        console.log "AWS Error Reading File: ", err
        callback err, null
        return

      filename = self.filePathToName(filePath)
      s3       = new AWS.S3
        params:
          Bucket: self.bucketName
          Key:    filename

      s3.putObject {Body: data}, (err, data)->
        if err
          console.log "AWS Error Uploading File: ", err
          callback err, null
          return
        callback null, self.awsUrl(filename)

module.exports = DappleAws
