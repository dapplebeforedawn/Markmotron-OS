Stackmotron = require 'stackmotron'
Twilio      = require 'dapple-twilio'
Email       = require 'dapple-sendgrid'

class StackmotronTwilio extends Stackmotron
  @pop: (req)->
    super req, req.body.Body

  @getStatus: (req)->
    return unless @extractSymbol(req.body.Body) == @STATUS_SYM
    to      = req.body.From
    message = if @isEmpty() then "Stackmotron is bored." else @topOfStack()["message"]
    twilio  = Twilio process.env.TWILIO_SID, process.env.TWILIO_AUTH, process.env.TWILIO_FROM
    twilio.send to, message, (err, resp)->
      console.log err if err
    return true

  @getContents: (req)->
    return unless @extractSymbol(req.body.Body) == @CONTENTS_SYM
    Email.send
      to      : process.env.STACKMOTRON_ADMIN_EMAIL
      from    : 'stackmotron.app@gmail.com'
      subject : 'What Stackmotron is up to'
      text    : @stack.map(JSON.stringify).join("\n\n")
    , (err, resp)->
      console.log err, resp
    return true

  @isTwilio = (req)->
    !!req.body.Body

  @handle: (req)->
    @isTwilio(req)              &&
    !@handleControlSymbol(req)  &&
    @pop(req)

  @handleControlSymbol: (req)->
    @getStatus(req)   ||
    @getContents(req)

      
module.exports = StackmotronTwilio
