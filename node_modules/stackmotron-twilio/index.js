// Generated by CoffeeScript 1.6.3
var Email, Stackmotron, StackmotronTwilio, Twilio, _ref,
  __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

Stackmotron = require('stackmotron');

Twilio = require('dapple-twilio');

Email = require('dapple-sendgrid');

StackmotronTwilio = (function(_super) {
  __extends(StackmotronTwilio, _super);

  function StackmotronTwilio() {
    _ref = StackmotronTwilio.__super__.constructor.apply(this, arguments);
    return _ref;
  }

  StackmotronTwilio.pop = function(req) {
    return StackmotronTwilio.__super__.constructor.pop.call(this, req, req.body.Body);
  };

  StackmotronTwilio.getStatus = function(req) {
    var message, to, twilio;
    if (this.extractSymbol(req.body.Body) !== this.STATUS_SYM) {
      return;
    }
    to = req.body.From;
    message = this.isEmpty() ? "Stackmotron is bored." : this.topOfStack()["message"];
    twilio = Twilio(process.env.TWILIO_SID, process.env.TWILIO_AUTH, process.env.TWILIO_FROM);
    twilio.send(to, message, function(err, resp) {
      if (err) {
        return console.log(err);
      }
    });
    return true;
  };

  StackmotronTwilio.getContents = function(req) {
    if (this.extractSymbol(req.body.Body) !== this.CONTENTS_SYM) {
      return;
    }
    Email.send({
      to: process.env.STACKMOTRON_ADMIN_EMAIL,
      from: 'stackmotron.app@gmail.com',
      subject: 'What Stackmotron is up to',
      text: this.stack.map(JSON.stringify).join("\n\n")
    }, function(err, resp) {
      return console.log(err, resp);
    });
    return true;
  };

  StackmotronTwilio.isTwilio = function(req) {
    return !!req.body.Body;
  };

  StackmotronTwilio.handle = function(req) {
    return this.isTwilio(req) && !this.handleControlSymbol(req) && this.pop(req);
  };

  StackmotronTwilio.handleControlSymbol = function(req) {
    return this.getStatus(req) || this.getContents(req);
  };

  return StackmotronTwilio;

})(Stackmotron);

module.exports = StackmotronTwilio;
